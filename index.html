<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Notion Calendar Widget</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; font-size: small; }
    .calendar {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      gap: 2px;
      max-width: 430px;
      margin: auto;
    }
    .day, .empty, .weekday, .weeknum {
      padding: 10px; border: 1px solid #ccc; border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .weekday { font-weight: bold; background: #d5d5d7; }
    .weeknum { font-weight: bold; background: #f7f7f5; text-align: center; }
    .weeknum a { text-decoration: none; color: #2a5d69; }
    .weeknum:hover { background: #2a5d69; }
    .weeknum:hover a { color: white; }
    .day a { text-decoration: none; color: #333; }
    .day.weekday { background: #f0efeb; }
    .day.weekend { font-weight: bold; background: #ebd8dc; }
    .day.weekday:hover, .day.weekend:hover {
      background: #97637c; color: white; border: 1px solid #d79d31;
    }
    .day.weekday:hover a, .day.weekend:hover a {
      color: white; font-weight: bold;
    }
    .day.today { background: #a793ac; color: white !important; font-weight: bold; }
    .day.today a { color: white !important; }
    .month-header {
      font-size: 1.5em; margin: 20px 0; display: flex;
      justify-content: center; align-items: center; gap: 20px;
    }
    .month-header a { text-decoration: none; color: #d79d31; }
    .nav-btn {
      cursor: pointer; font-size: 1.2em; padding: 5px 10px;
      border: 1px solid #ccc; border-radius: 4px; background: #f0efeb;
    }
    .nav-btn:hover { background: #a793ac; }
    .today-btn {
      cursor: pointer; font-size: 1em; padding: 5px 15px;
      border: 1px solid #ccc; border-radius: 4px; background: #d5d5d7;
      margin-left: 10px;
    }
    .today-btn:hover { background: #a793ac; color: white; border: 1px solid #d79d31; }
    
    /* Highlight rollover weeks (weeks that belong to the next year) */
    .weeknum.rollover {
      background-color: #B4B393;   /* Satin Slipper highlight */
  /*    border: 1px solid #d79d31; */  /* subtle orange border */
      border-radius: 4px;
      font-weight: bold;
      color: #2a5d69;              /* darker text for contrast */
      padding: 4px 6px;
    }
  </style>
</head>
<body>
  <div class="month-header">
    <span class="nav-btn" onclick="prevMonth()">&#8592;</span>
    <a id="month-link" href="#" target="_blank" rel="noopener noreferrer">Month</a>
    <span class="nav-btn" onclick="nextMonth()">&#8594;</span>
    <button class="today-btn" onclick="goToday()">Today</button>
  </div>
 <div id="loading" style="margin:10px; font-style:italic; color:#666;">
 </div> <div class="calendar" id="calendar"></div>

 <script>
  const notionApiBase = "https://notion-calendar-widget-eight.vercel.app/api/getNotionPage";

  const calendarEl = document.getElementById('calendar');
  const monthLink = document.getElementById('month-link');
  let currentDate = new Date();

  async function getNotionPageLink(nameString) {
    try {
      const response = await fetch(`${notionApiBase}?date=${nameString}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      console.log("API response for", nameString, data); // üîé Debug
      if (data && data.url) {
        return data.url;
      } else {
        return "ERROR"; // show ‚ö†Ô∏è instead of falling back to "#"
      }
    } catch (err) {
      console.error(`Error fetching page for ${nameString}:`, err);
      return "ERROR";
    }
  }

  function formatDate(year, month, day) {
    const m = String(month).padStart(2, '0');
    const d = String(day).padStart(2, '0');
    return `${year}-${m}-${d}`;
  }

  function getISOWeekYearAndNumber(date) {
    const tmp = new Date(date.valueOf());
    // Set to nearest Thursday: current date + 4 - current day number
    tmp.setDate(tmp.getDate() + 4 - (tmp.getDay() || 7));
    const yearStart = new Date(tmp.getFullYear(), 0, 1);
    const weekNumber = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
    const weekYear = tmp.getFullYear();
    return { weekYear, weekNumber };
  }

  async function renderCalendar(date) {
    const loadingEl = document.getElementById('loading');
    loadingEl.textContent = "Fetching Notion links‚Ä¶ ‚è≥";
    calendarEl.innerHTML = '';
  
    const year = date.getFullYear();
    const month = date.getMonth();
    const monthName = date.toLocaleString('default', { month: 'long' });
  
    monthLink.textContent = `${monthName} ${year}`;
  
    // --- Build all name strings ---
    const nameStrings = [];
  
    // Monthly link (YYYY-MM)
    const monthDateStr = `${year}-${String(month+1).padStart(2,'0')}`;
    nameStrings.push(monthDateStr);
  
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
  
    let dayCounter = 1;
    let started = false;
    let rowIndex = 0;
    const firstSundayOfGrid = new Date(year, month, 1 - firstDay);
  
    while (dayCounter <= daysInMonth) {
      const sundayOfRow = new Date(firstSundayOfGrid);
      sundayOfRow.setDate(firstSundayOfGrid.getDate() + rowIndex * 7);
      const mondayOfRow = new Date(sundayOfRow);
      mondayOfRow.setDate(sundayOfRow.getDate() + 1);
  
      const { weekYear, weekNumber } = getISOWeekYearAndNumber(mondayOfRow);
      const weekString = `${weekYear}-W${weekNumber}`;
      nameStrings.push(weekString);
  
      for (let dow = 0; dow < 7; dow++) {
        if (!started && dow < firstDay) {
          // empty cell
        } else if (dayCounter <= daysInMonth) {
          const dateStr = formatDate(year, month+1, dayCounter);
          nameStrings.push(dateStr);
          dayCounter++;
        }
      }
      rowIndex++;
    }
  
    // --- Run all fetches in parallel ---
    const urls = await Promise.all(nameStrings.map(ns => getNotionPageLink(ns)));
  
    // Build dictionary
    const results = {};
    nameStrings.forEach((ns, i) => {
      results[ns] = urls[i];
    });
  
    // Monthly link
    const monthUrl = results[monthDateStr];
    monthLink.href = monthUrl === "ERROR" ? "#" : monthUrl;
  
    // Weekday headers
    const weekdays = ['Wk','Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    weekdays.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'weekday';
      cell.textContent = day;
      calendarEl.appendChild(cell);
    });
  
    // Reset counters for grid build
    dayCounter = 1;
    started = false;
    rowIndex = 0;
  
    while (dayCounter <= daysInMonth) {
      const sundayOfRow = new Date(firstSundayOfGrid);
      sundayOfRow.setDate(firstSundayOfGrid.getDate() + rowIndex * 7);
      const mondayOfRow = new Date(sundayOfRow);
      mondayOfRow.setDate(sundayOfRow.getDate() + 1); 
 
      // Weekly cell
      const { weekYear, weekNumber } = getISOWeekYearAndNumber(mondayOfRow);
      const weekString = `${weekYear}-W${weekNumber}`;
      
      const weekNumCell = document.createElement('div');
      weekNumCell.className = 'weeknum';
      
      const weekLink = document.createElement('a');
      const weekUrl = results[weekString];
      
      // Show week number, and optionally the year if it differs from the current year
      weekLink.textContent = weekUrl === "ERROR"
        ? `W${weekNumber} ‚ö†Ô∏è`
        : (weekYear !== year ? `W${weekNumber} (${weekYear})` : `W${weekNumber}`);
      
      weekLink.href = weekUrl === "ERROR" ? "#" : weekUrl;
      weekLink.target = "_blank";
      weekLink.rel = "noopener noreferrer";
      
      weekNumCell.appendChild(weekLink);
      calendarEl.appendChild(weekNumCell);
  
      for (let dow = 0; dow < 7; dow++) {
        if (!started && dow < firstDay) {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'empty';
          calendarEl.appendChild(emptyCell);
        } else if (dayCounter <= daysInMonth) {
          started = true;
          const dayCell = document.createElement('div');
          dayCell.className = 'day';
          const dayLink = document.createElement('a');
          const dateStr = formatDate(year, month+1, dayCounter);
          const dayUrl = results[dateStr];
          dayLink.textContent = dayUrl === "ERROR" ? `${dayCounter} ‚ö†Ô∏è` : dayCounter;
          dayLink.href = dayUrl === "ERROR" ? "#" : dayUrl;
          dayLink.target = "_blank";
          dayLink.rel = "noopener noreferrer";
          dayCell.appendChild(dayLink);
  
          const today = new Date();
          if (dayCounter === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear()) {
            dayCell.classList.add('today');
          }
  
          if (dow === 0 || dow === 6) {
            dayCell.classList.add('weekend');
          } else {
            dayCell.classList.add('weekday');
          }

          if (weekYear !== year) {
            weekNumCell.classList.add('rollover');
          }

          calendarEl.appendChild(dayCell);
          dayCounter++;
        } else {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'empty';
          calendarEl.appendChild(emptyCell);
        }
      }
      rowIndex++;
    }
  
    loadingEl.textContent = "";
  }

  function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); }
  function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); }
  function goToday() { currentDate = new Date(); renderCalendar(currentDate); }

  renderCalendar(currentDate);
</script>
</body>
</html>
