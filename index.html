<script>
  const notionApiBase = "https://notion-calendar-widget-eight.vercel.app/api/getNotionPage"; // backend endpoint

  const calendarEl = document.getElementById('calendar');
  const monthLink = document.getElementById('month-link');
  let currentDate = new Date();

  async function getNotionPageLink(dateString, type) {
    try {
      const response = await fetch(`${notionApiBase}?date=${dateString}&type=${type}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      return data.url || "#";
    } catch (err) {
      console.error(`Error fetching ${type} page for ${dateString}:`, err);
      return "ERROR"; // special marker we‚Äôll handle later
    }
  }


  function formatDate(year, month, day) {
    const m = String(month).padStart(2, '0');
    const d = String(day).padStart(2, '0');
    return `${year}-${m}-${d}`;
  }

  function getWeekNumber(date) {
    const temp = new Date(date.getTime());
    temp.setHours(0,0,0,0);
    temp.setDate(temp.getDate() + 3 - ((temp.getDay() + 6) % 7));
    const week1 = new Date(temp.getFullYear(), 0, 4);
    return 1 + Math.round(((temp - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
  }

async function renderCalendar(date) {
  const loadingEl = document.getElementById('loading');
  loadingEl.textContent = "Fetching Notion links‚Ä¶ ‚è≥";
  calendarEl.innerHTML = '';

  const year = date.getFullYear();
  const month = date.getMonth();
  const monthName = date.toLocaleString('default', { month: 'long' });

  monthLink.textContent = `${monthName} ${year}`;

  // --- Build all fetch promises ---
  const promises = [];

  // Monthly link
  const monthDateStr = `${year}-${String(month+1).padStart(2,'0')}`;
  promises.push(getNotionPageLink(monthDateStr, "Monthly"));

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  let dayCounter = 1;
  let started = false;
  let rowIndex = 0;
  const firstSundayOfGrid = new Date(year, month, 1 - firstDay);

  const weekRequests = [];
  const dayRequests = [];

  while (dayCounter <= daysInMonth) {
    const sundayOfRow = new Date(firstSundayOfGrid);
    sundayOfRow.setDate(firstSundayOfGrid.getDate() + rowIndex * 7);
    const mondayOfRow = new Date(sundayOfRow);
    mondayOfRow.setDate(sundayOfRow.getDate() + 1);

    const isoWeek = getWeekNumber(mondayOfRow);
    weekRequests.push(getNotionPageLink(`${year}-W${isoWeek}`, "Weekly"));

    for (let dow = 0; dow < 7; dow++) {
      if (!started && dow < firstDay) {
        // empty cell, no fetch
      } else if (dayCounter <= daysInMonth) {
        const dateStr = formatDate(year, month+1, dayCounter);
        dayRequests.push(getNotionPageLink(dateStr, "Daily"));
        dayCounter++;
      }
    }
    rowIndex++;
  }

  // Add weekly + daily requests to promises
  promises.push(...weekRequests, ...dayRequests);

  // --- Run all fetches in parallel ---
  const results = await Promise.all(promises);

  // --- Assign results back ---
  let resultIndex = 0;

  // Monthly
  const monthUrl = results[resultIndex++];
  if (monthUrl === "ERROR") {
    monthLink.href = "#";
    monthLink.textContent = `${monthName} ${year} ‚ö†Ô∏è`;
  } else {
    monthLink.href = monthUrl;
    monthLink.target = "_blank";
    monthLink.rel = "noopener noreferrer";
  }

  // Weekday headers
  const weekdays = ['Wk','Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  weekdays.forEach(day => {
    const cell = document.createElement('div');
    cell.className = 'weekday';
    cell.textContent = day;
    calendarEl.appendChild(cell);
  });

  dayCounter = 1;
  started = false;
  rowIndex = 0;

  while (dayCounter <= daysInMonth) {
    const sundayOfRow = new Date(firstSundayOfGrid);
    sundayOfRow.setDate(firstSundayOfGrid.getDate() + rowIndex * 7);
    const mondayOfRow = new Date(sundayOfRow);
    mondayOfRow.setDate(sundayOfRow.getDate() + 1);

    const isoWeek = getWeekNumber(mondayOfRow);

    // Weekly cell
    const weekNumCell = document.createElement('div');
    weekNumCell.className = 'weeknum';
    const weekLink = document.createElement('a');
    weekLink.textContent = isoWeek;
    
    const weekUrl = results[resultIndex++];
    if (weekUrl === "ERROR") {
      weekLink.href = "#";
      weekLink.textContent = `${isoWeek} ‚ö†Ô∏è`;
    } else {
      weekLink.href = weekUrl;
      weekLink.target = "_blank";
      weekLink.rel = "noopener noreferrer";
    }
    
    weekNumCell.appendChild(weekLink);
    calendarEl.appendChild(weekNumCell);
    

    for (let dow = 0; dow < 7; dow++) {
      if (!started && dow < firstDay) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'empty';
        calendarEl.appendChild(emptyCell);
      } else if (dayCounter <= daysInMonth) {
        started = true;

        // Daily cell
        const dayCell = document.createElement('div');
        dayCell.className = 'day';
        const dayLink = document.createElement('a');
        dayLink.textContent = dayCounter;
        
        const dayUrl = results[resultIndex++];
        if (dayUrl === "ERROR") {
          dayLink.href = "#";
          dayLink.textContent = `${dayCounter} ‚ö†Ô∏è`;
        } else {
          dayLink.href = dayUrl;
          dayLink.target = "_blank";
          dayLink.rel = "noopener noreferrer";
        }
        
        dayCell.appendChild(dayLink);

        const today = new Date();
        if (dayCounter === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()) {
          dayCell.classList.add('today');
        }

        if (dow === 0 || dow === 6) {
          dayCell.classList.add('weekend');
        } else {
          dayCell.classList.add('weekday');
        }

        calendarEl.appendChild(dayCell);
        dayCounter++;
      } else {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'empty';
        calendarEl.appendChild(emptyCell);
      }
    }
    rowIndex++;
  }

  // --- Clear loading indicator ---
  loadingEl.textContent = "";
}

  function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); }
  function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); }
  function goToday() { currentDate = new Date(); renderCalendar(currentDate); }

  // üîó Initial render
  renderCalendar(currentDate);
</script>
